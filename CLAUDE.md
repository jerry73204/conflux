# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Project Overview

msync is a ROS2 node written in Rust that synchronizes messages from multiple input topics within configurable time windows. It uses the `multi-stream-synchronizer` library (included as a git submodule) to perform the synchronization algorithm.

## Build System

This project uses `colcon-cargo-ros2` to build Rust code as a ROS2 package.

**IMPORTANT: Always use the justfile for building and development tasks.**

```bash
# Build the project (ALWAYS use this)
just build

# Never run colcon or cargo commands directly for building
# The justfile handles proper ROS2 environment setup and configuration
```

## Common Development Commands

```bash
# Show available commands
just

# Build with colcon (primary build method)
just build

# Build with verbose output
just build-verbose

# Build in debug mode (faster compilation)
just build-debug

# Format code
just format

# Run lints (requires prior build)
just lint

# Run all checks
just check

# Run tests
just test

# Run the node (after build)
just run

# Clean all artifacts
just clean

# Update git submodules
just submodules
```

## Project Structure

```
msync/
├── Cargo.toml              # Rust package manifest
├── package.xml             # ROS2 package manifest
├── justfile                # Build and development commands
├── .envrc                  # direnv config (sources ROS2)
├── config/
│   ├── example.yaml        # Documented configuration example
│   └── presets/            # Pre-configured settings
│       ├── high_frequency.yaml
│       ├── low_frequency.yaml
│       └── batch_processing.yaml
├── src/
│   ├── main.rs             # Entry point
│   ├── lib.rs              # Library root
│   ├── config.rs           # Configuration parsing
│   ├── message.rs          # TimestampedMessage wrapper
│   ├── message_impl.rs     # HasHeader impls for sensor_msgs types
│   ├── node.rs             # MsyncNode implementation
│   ├── subscriber.rs       # Generic subscription factory
│   └── traits.rs           # HasHeader, Timestamped traits
├── multi-stream-synchronizer/  # Submodule with sync algorithm
└── external/               # Reference repos (gitignored)
```

## Architecture

### Generic Message Handling

The node supports multiple ROS2 message types through a trait-based approach inspired by
the C++ `message_filters` library (see `external/message_filters` for reference).

**Key patterns:**
- `HasHeader` trait: Extracts timestamps from messages with `std_msgs/Header`
- `Timestamped` trait: Blanket impl for any `HasHeader` type
- `AnySubscription` enum: Type-erased subscription storage
- `create_typed_subscription<M>`: Generic subscription factory

**Supported message types:**
- `sensor_msgs/msg/Image`
- `sensor_msgs/msg/PointCloud2`
- `sensor_msgs/msg/Imu`
- `sensor_msgs/msg/LaserScan`
- `sensor_msgs/msg/CameraInfo`
- `sensor_msgs/msg/CompressedImage`
- `sensor_msgs/msg/NavSatFix`
- `sensor_msgs/msg/Range`
- `sensor_msgs/msg/JointState`
- `sensor_msgs/msg/Joy`

To add a new message type:
1. Add `HasHeader` impl in `src/message_impl.rs`
2. Add variant to `AnySubscription` enum in `src/subscriber.rs`
3. Add match arm in `create_subscription_for_type()`

## Configuration

The node requires a YAML configuration file. Users must provide:
- Input topics and their message types
- Output topic
- Synchronization parameters (window_size, buffer_size)

See `config/example.yaml` for full documentation.

## Dependencies

- **multi-stream-synchronizer**: Core synchronization algorithm (local submodule)
- **rclrs**: ROS2 Rust client library
- **tokio**: Async runtime for synchronization tasks
- **sensor_msgs, std_msgs**: ROS2 message types (resolved via colcon build)

## Build Notes

- ROS2 message crates (`sensor_msgs`, `std_msgs`, etc.) use wildcard versions (`*`) in Cargo.toml
- These are patched at build time via `build/ros2_cargo_config.toml` generated by colcon
- Direct `cargo build` will fail - always use `just build`
- The `test-release` profile provides release optimizations with debug symbols

## Testing

```bash
# Run all tests (requires prior build for ROS2 types)
just test

# Run only the multi-stream-synchronizer library tests
just test-lib
```
